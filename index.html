<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DF ACADEMY · Calculadora de Tamaño de Posición</title>
  <meta name="description" content="Calculadora avanzada de tamaño de posición para trading Forex, Oro, Petróleo y más, por DF ACADEMY." />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#040D51" />
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="DF Calc" />
  <link rel="icon" type="image/png" href="assets/icon-192.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{background:#fafafa}</style>
</head>
<body class="text-neutral-900">
<header class="sticky top-0 z-40 shadow-sm" style="background:#040D51;">
  <div class="max-w-6xl mx-auto px-4 h-14 flex items-center gap-3">
    <img src="assets/logo.png" class="h-8 w-auto" />
    <span class="text-white/90 text-sm">DF ACADEMY · Herramientas de Trading</span>
  </div>
</header>

<!-- Ticker TradingView -->
<div id="tv-tape" style="background:#040D51;border-bottom:1px solid #0b1355;">
  <div class="tradingview-widget-container" style="max-width:100%;margin:0 auto;">
    <div class="tradingview-widget-container__widget"></div>
    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
    {
      "symbols": [
        { "proName": "FX:EURUSD", "title": "EUR/USD" },
        { "proName": "OANDA:XAUUSD", "title": "XAU/USD" },
        { "proName": "FX:GBPUSD", "title": "GBP/USD" },
        { "proName": "FX:USDJPY", "title": "USD/JPY" },
        { "proName": "CAPITALCOM:US500", "title": "S&P 500" },
        { "proName": "BINANCE:BTCUSDT", "title": "BTC/USDT" }
      ],
      "colorTheme": "dark", "isTransparent": true, "displayMode": "adaptive", "locale": "es"
    }
    </script>
  </div>
</div>

<!-- Calculadora -->
<main class="max-w-6xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-semibold text-brand">DF ACADEMY – Calculadora de Tamaño de Posición</h1>
  <p class="mt-2 text-neutral-600">Calcula tu posición, riesgo y valor pip. Compatible con Forex, Oro y Petróleo.</p>

  <div class="grid md:grid-cols-2 gap-6 mt-8">
    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <h2 class="text-lg font-semibold mb-3">Parámetros</h2>

      <label class="block text-sm">Par</label>
      <select id="symbol" class="w-full rounded border px-3 py-2 mb-3">
        <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>XAUUSD</option>
        <option>XAGUSD</option><option>USOIL</option><option>UKOIL</option>
      </select>

      <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-sm">Divisa cuenta</label>
          <select id="accountCcy" class="w-full rounded border px-3 py-2">
            <option>USD</option><option>EUR</option><option>JPY</option>
          </select>
        </div>
        <div>
          <label class="block text-sm">Balance</label>
          <input id="balance" type="number" value="1000" class="w-full rounded border px-3 py-2" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-sm">Riesgo (%)</label>
          <input id="riskPct" type="number" value="1" step="0.01" class="w-full rounded border px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm">Stop Loss (pips)</label>
          <input id="stopPips" type="number" value="20" class="w-full rounded border px-3 py-2" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-sm">Precio actual</label>
          <input id="price" type="number" value="1.1000" step="0.0001" class="w-full rounded border px-3 py-2" />
        </div>

        <!-- Tipo de cambio -->
        <div>
          <label class="block text-sm">TC cotizada → cuenta</label>
          <div class="flex items-center gap-2 mt-1">
            <input id="conv" type="number" step="0.0001" value="1.0000"
                   class="w-full rounded border px-3 py-2" />
            <label class="flex items-center gap-2 text-sm select-none">
              <input id="autoConv" type="checkbox" class="h-4 w-4" checked /> Auto
            </label>
          </div>
          <p class="text-[11px] text-neutral-500 mt-1">Se completa automáticamente (fuente: exchangerate.host).</p>
        </div>
      </div>

      <button id="btnCalc" class="px-4 py-2 text-white rounded" style="background:#040D51;">Calcular</button>
    </div>

    <!-- Resultados -->
    <section class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-indigo-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600" viewBox="0 0 24 24" fill="currentColor"><path d="M3 5a2 2 0 012-2h1a2 2 0 012 2v14H5a2 2 0 01-2-2V5zm6 0a2 2 0 012-2h1a2 2 0 012 2v14h-5V5zm7 0a2 2 0 012-2h1a2 2 0 012 2v12a2 2 0 01-2 2h-5V5z"/></svg>
        </span>
        <h2 class="text-xl font-semibold">Resultados</h2>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="border rounded-xl p-4"><p class="text-sm text-neutral-600">Riesgo monetario</p><p id="riskMoneyOut" class="mt-2 text-3xl font-semibold tracking-tight">—</p></div>
        <div class="border rounded-xl p-4"><p class="text-sm text-neutral-600">Valor por pip (por unidad)</p><p class="mt-2 text-3xl font-semibold tracking-tight"><span id="pipValueOut">—</span><span class="text-neutral-500 text-xl"> / unidades</span></p></div>
        <div class="border rounded-xl p-4"><p class="text-sm text-neutral-600">Unidades (unidades)</p><p id="unitsOut" class="mt-2 text-3xl font-semibold tracking-tight">—</p></div>
        <div class="border rounded-xl p-4"><p class="text-sm text-neutral-600">Lotes (100,000 unidades)</p><p id="lotsOut" class="mt-2 text-3xl font-semibold tracking-tight">—</p></div>
        <div class="border rounded-xl p-4"><p class="text-sm text-neutral-600">Mini lotes (0.1)</p><p id="miniLotsOut" class="mt-2 text-3xl font-semibold tracking-tight">—</p></div>
        <div class="border rounded-xl p-4"><p class="text-sm text-neutral-600">Micro lotes (0.01)</p><p id="microLotsOut" class="mt-2 text-3xl font-semibold tracking-tight">—</p></div>
      </div>

      <div class="mt-6">
        <h3 class="text-base font-semibold mb-2">Notas rápidas</h3>
        <ul class="list-disc pl-5 space-y-1 text-[15px] text-neutral-700">
          <li>Para JPY, el pip estándar es 0.01.</li>
          <li>Si la divisa de la cuenta ≠ cotizada, usa el tipo de cambio cotizada→cuenta.</li>
          <li>FX: 1 lote = 100,000 unidades; XAUUSD: 1 lote = 100 onzas; XAGUSD: 1 lote = 5,000 onzas; USOIL/UKOIL: 1 lote = 100 barriles.</li>
          <li>No incluye comisiones, spreads ni deslizamiento.</li>
          <li id="instrumentTip" class="text-neutral-600"></li>
        </ul>
      </div>
    </section>
  </div>
</main>

<script>
const INSTRUMENTS = {
  _fx:{type:'fx',lotSize:100000,pipSize:0.0001,unitLabel:'unidades'},
  _fxJPY:{type:'fx',lotSize:100000,pipSize:0.01,unitLabel:'unidades'},
  XAUUSD:{type:'cmd',pipSize:0.01,lotSize:100,unitLabel:'onzas',note:'XAUUSD: 1 pip = 0.01 USD/onza'},
  XAGUSD:{type:'cmd',pipSize:0.01,lotSize:5000,unitLabel:'onzas',note:'XAGUSD: 1 pip = 0.01 USD/onza'},
  USOIL:{type:'cmd',pipSize:0.01,lotSize:100,unitLabel:'barriles',note:'USOIL: 1 pip = 0.01 USD/barril'},
  UKOIL:{type:'cmd',pipSize:0.01,lotSize:100,unitLabel:'barriles',note:'UKOIL: 1 pip = 0.01 USD/barril'}
};
function resolveInstrument(s){if(INSTRUMENTS[s])return INSTRUMENTS[s];const q=s.slice(3,6);return(q==='JPY'||s.endsWith('JPY'))?INSTRUMENTS._fxJPY:INSTRUMENTS._fx;}
function pipValuePerUnit(i,c=1){return i.pipSize*(+c||1);}
function fmt(n,d=2){return isFinite(n)?(+n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}):'—';}

// === AUTO TC ===
const FXCACHE_TTL_MS=5*60*1000;
function cacheGetFx(k){try{const r=localStorage.getItem('fx:'+k);if(!r)return null;const {t,v}=JSON.parse(r);if(Date.now()-t>FXCACHE_TTL_MS)return null;return v;}catch{return null;}}
function cacheSetFx(k,v){try{localStorage.setItem('fx:'+k,JSON.stringify({t:Date.now(),v}));}catch{}}
async function getFxRate(f,t){if(!f||!t||f===t)return 1;const key=`${f}_${t}`;const c=cacheGetFx(key);if(c)return c;try{const res=await fetch(`https://api.exchangerate.host/convert?from=${f}&to=${t}`);const d=await res.json();const v=+d?.result;if(v>0){cacheSetFx(key,v);return v;}return 1;}catch{return 1;}}
async function autoFillConvIfNeeded(){const auto=document.getElementById('autoConv')?.checked;const conv=document.getElementById('conv');if(!auto)return;const s=document.getElementById('symbol').value;const acc=document.getElementById('accountCcy').value.toUpperCase();const i=resolveInstrument(s);const q=(i.quote||s.slice(3,6)).toUpperCase();if(q===acc){conv.value='1.0000';conv.readOnly=true;return;}conv.readOnly=true;const v=await getFxRate(q,acc);conv.value=v.toFixed(4);}

// === CÁLCULO ===
function recalc(){
  const s=document.getElementById('symbol').value,acc=document.getElementById('accountCcy').value.toUpperCase();
  const bal=+document.getElementById('balance').value,risk=+document.getElementById('riskPct').value,stop=+document.getElementById('stopPips').value,conv=+document.getElementById('conv').value;
  const i=resolveInstrument(s),q=(i.quote||s.slice(3,6)).toUpperCase(),cv=(acc===q)?1:(conv||1);
  const pip=pipValuePerUnit(i,cv),money=bal*(risk/100),units=money/(stop*pip),lots=units/(i.lotSize||100000);
  const miniLots=lots/0.1,microLots=lots/0.01;
  document.getElementById('riskMoneyOut').textContent=`${fmt(money,2)} ${acc}`;
  document.getElementById('pipValueOut').textContent=`${fmt(pip,6)} ${acc}`;
  document.getElementById('unitsOut').textContent=fmt(units,0);
  document.getElementById('lotsOut').textContent=fmt(lots,2);
  document.getElementById('miniLotsOut').textContent=fmt(miniLots,1);
  document.getElementById('microLotsOut').textContent=fmt(microLots,0);
  document.getElementById('instrumentTip').textContent=i.note||'';
}

// === EVENTOS ===
['symbol','accountCcy','balance','riskPct','stopPips','conv'].forEach(id=>{document.getElementById(id).addEventListener('input',recalc);document.getElementById(id).addEventListener('change',recalc);});
document.getElementById('btnCalc').addEventListener('click',recalc);
document.getElementById('autoConv').addEventListener('change',()=>{const conv=document.getElementById('conv');conv.readOnly=document.getElementById('autoConv').checked;autoFillConvIfNeeded().then(recalc);});
['symbol','accountCcy'].forEach(id=>{document.getElementById(id).addEventListener('change',async()=>{await autoFillConvIfNeeded();recalc();});});
(async()=>{const a=document.getElementById('autoConv');const c=document.getElementById('conv');if(a){c.readOnly=a.checked;await autoFillConvIfNeeded();}recalc();})();
</script>
</body>
</html>
