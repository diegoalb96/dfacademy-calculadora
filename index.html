<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DF ACADEMY ¬∑ Calculadora de Tama√±o de Posici√≥n</title>
  <meta name="description" content="Calculadora de tama√±o de posici√≥n para trading de Forex, Metales, √çndices, Criptomonedas y Commodities por DF ACADEMY." />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#040D51" />
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DF Calc" />
  <link rel="icon" type="image/png" href="assets/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <script>tailwind={config:{theme:{extend:{colors:{brand:'#040D51',accent:'#F7BE0C',brandLight:'#0b1355'},fontFamily:{sans:['DM Sans','sans-serif'],mono:['JetBrains Mono','monospace']}}}}}</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);font-family:'DM Sans',sans-serif}
    .result-card{transition:all 0.2s ease}
    .result-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px -5px rgba(4,13,81,0.1)}
    select,input{font-family:'DM Sans',sans-serif}
    .mono{font-family:'JetBrains Mono',monospace}
    .category-badge{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .cat-forex{background:#dbeafe;color:#1e40af}
    .cat-metals{background:#fef3c7;color:#92400e}
    .cat-energy{background:#fee2e2;color:#991b1b}
    .cat-indices{background:#d1fae5;color:#065f46}
    .cat-crypto{background:#ede9fe;color:#5b21b6}
    optgroup{font-weight:700;color:#040D51;background:#f8fafc}
    .gradient-border{background:linear-gradient(135deg,#040D51,#F7BE0C);padding:1px;border-radius:12px}
    .gradient-border>div{background:white;border-radius:11px}
    .accuracy-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600}
    .accuracy-high{background:#d1fae5;color:#065f46}
    .accuracy-low{background:#fee2e2;color:#991b1b}
    .info-box{background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border:1px solid #bfdbfe}
    .warning-box{background:linear-gradient(135deg,#fefce8 0%,#fef3c7 100%);border:1px solid #fde047}
    .price-box{background:linear-gradient(135deg,#fdf4ff 0%,#fae8ff 100%);border:2px solid #e879f9}
    .collapsible-header{cursor:pointer;user-select:none}
    .collapsible-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out}
    .collapsible-content.open{max-height:3000px}
    .tab-btn{transition:all 0.2s}
    .tab-btn.active{background:#040D51;color:white}
    .conversion-indicator{animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
  </style>
</head>
<body class="text-neutral-900 min-h-screen">
  <header class="sticky top-0 z-[40] shadow-lg" style="background:linear-gradient(90deg,#040D51 0%,#0b1355 100%)">
    <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="assets/logo.png" alt="DF Academy" class="h-8 w-auto" onerror="this.style.display='none'" />
        <span class="text-white/90 text-sm font-medium">Herramientas de Trading</span>
      </div>
      <span class="hidden sm:inline-block text-xs text-white/60 bg-white/10 px-2 py-1 rounded">v3.0</span>
    </div>
  </header>

  <div id="tv-tape" style="background:#040D51;border-bottom:1px solid #0b1355">
    <div class="tradingview-widget-container" style="max-width:100%;margin:0 auto">
      <div class="tradingview-widget-container__widget"></div>
      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
      {"symbols":[{"proName":"FX:EURUSD","title":"EUR/USD"},{"proName":"OANDA:XAUUSD","title":"XAU/USD"},{"proName":"FX:GBPUSD","title":"GBP/USD"},{"proName":"FX:USDJPY","title":"USD/JPY"},{"proName":"CAPITALCOM:US500","title":"S&P 500"},{"proName":"BINANCE:BTCUSDT","title":"BTC/USDT"}],"showSymbolLogo":true,"isTransparent":true,"displayMode":"adaptive","colorTheme":"dark","locale":"es"}
      </script>
    </div>
  </div>

  <main class="min-h-screen w-full">
    <section class="max-w-6xl mx-auto px-4 py-8">
      <div class="text-center mb-6">
        <h1 class="text-3xl sm:text-4xl font-bold tracking-tight">
          <span style="color:#040D51">DF ACADEMY</span> <span class="text-neutral-400">¬∑</span> Calculadora de Posici√≥n
        </h1>
        <p class="mt-3 text-neutral-600 max-w-2xl mx-auto">Calcula el tama√±o √≥ptimo de tu posici√≥n basado en tu gesti√≥n de riesgo.</p>
        <div class="flex flex-wrap justify-center gap-2 mt-4">
          <span class="category-badge cat-forex">Forex</span>
          <span class="category-badge cat-metals">Metales</span>
          <span class="category-badge cat-energy">Energ√≠a</span>
          <span class="category-badge cat-indices">√çndices</span>
          <span class="category-badge cat-crypto">Cripto</span>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-6">
        <div class="space-y-6">
          <div class="gradient-border">
            <div class="bg-white shadow-sm rounded-xl p-6">
              <div class="flex items-center gap-2 mb-5">
                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-brand text-white font-bold text-lg">‚öôÔ∏è</span>
                <div>
                  <h2 class="text-lg font-bold text-brand">Par√°metros de la Operaci√≥n</h2>
                  <p class="text-xs text-neutral-500">Configura tu trade</p>
                </div>
              </div>

              <label class="block text-sm font-semibold text-neutral-700">Instrumento</label>
              <select id="symbol" class="mt-1 w-full rounded-lg border-2 border-neutral-200 px-3 py-2.5 focus:border-brand focus:outline-none">
                <optgroup label="üìà FOREX - Mayores">
                  <option value="EURUSD">EUR/USD</option><option value="GBPUSD">GBP/USD</option><option value="USDJPY">USD/JPY</option>
                  <option value="USDCHF">USD/CHF</option><option value="AUDUSD">AUD/USD</option><option value="USDCAD">USD/CAD</option><option value="NZDUSD">NZD/USD</option>
                </optgroup>
                <optgroup label="üìä FOREX - Cruces EUR">
                  <option value="EURGBP">EUR/GBP</option><option value="EURJPY">EUR/JPY</option><option value="EURCHF">EUR/CHF</option>
                  <option value="EURAUD">EUR/AUD</option><option value="EURCAD">EUR/CAD</option><option value="EURNZD">EUR/NZD</option>
                </optgroup>
                <optgroup label="üìä FOREX - Cruces GBP">
                  <option value="GBPJPY">GBP/JPY</option><option value="GBPCHF">GBP/CHF</option><option value="GBPAUD">GBP/AUD</option>
                  <option value="GBPCAD">GBP/CAD</option><option value="GBPNZD">GBP/NZD</option>
                </optgroup>
                <optgroup label="üìä FOREX - Cruces AUD/CAD/NZD/CHF">
                  <option value="AUDJPY">AUD/JPY</option><option value="AUDCHF">AUD/CHF</option><option value="AUDCAD">AUD/CAD</option><option value="AUDNZD">AUD/NZD</option>
                  <option value="CADJPY">CAD/JPY</option><option value="CADCHF">CAD/CHF</option><option value="CHFJPY">CHF/JPY</option>
                  <option value="NZDJPY">NZD/JPY</option><option value="NZDCHF">NZD/CHF</option><option value="NZDCAD">NZD/CAD</option>
                </optgroup>
                <optgroup label="üåç FOREX - Ex√≥ticos USD">
                  <option value="USDMXN">USD/MXN</option><option value="USDZAR">USD/ZAR</option><option value="USDTRY">USD/TRY</option>
                  <option value="USDSEK">USD/SEK</option><option value="USDNOK">USD/NOK</option><option value="USDDKK">USD/DKK</option>
                  <option value="USDSGD">USD/SGD</option><option value="USDHKD">USD/HKD</option><option value="USDPLN">USD/PLN</option>
                  <option value="USDHUF">USD/HUF</option><option value="USDCZK">USD/CZK</option><option value="USDCNH">USD/CNH</option>
                </optgroup>
                <optgroup label="üåç FOREX - Ex√≥ticos EUR/GBP">
                  <option value="EURTRY">EUR/TRY</option><option value="EURMXN">EUR/MXN</option><option value="EURZAR">EUR/ZAR</option>
                  <option value="EURSEK">EUR/SEK</option><option value="EURNOK">EUR/NOK</option><option value="EURPLN">EUR/PLN</option>
                  <option value="GBPZAR">GBP/ZAR</option><option value="GBPTRY">GBP/TRY</option><option value="GBPMXN">GBP/MXN</option>
                </optgroup>
                <optgroup label="ü•á METALES (‚ö†Ô∏è Verificar Broker)">
                  <option value="XAUUSD">XAU/USD (Oro)</option><option value="XAGUSD">XAG/USD (Plata)</option>
                  <option value="XAUEUR">XAU/EUR (Oro/Euro)</option><option value="XPTUSD">XPT/USD (Platino)</option>
                </optgroup>
                <optgroup label="‚õΩ ENERG√çAS (‚ö†Ô∏è Verificar Broker)">
                  <option value="USOIL">USOIL / WTI</option><option value="UKOIL">UKOIL / Brent</option><option value="NGAS">Gas Natural</option>
                </optgroup>
                <optgroup label="üìâ √çNDICES (‚ö†Ô∏è Verificar Broker)">
                  <option value="US30">US30 / Dow Jones</option><option value="US500">US500 / S&P 500</option>
                  <option value="US100">US100 / NASDAQ</option><option value="GER40">GER40 / DAX</option>
                  <option value="UK100">UK100 / FTSE</option><option value="JPN225">JPN225 / Nikkei</option>
                </optgroup>
                <optgroup label="‚Çø CRIPTOMONEDAS (‚ö†Ô∏è Verificar Broker)">
                  <option value="BTCUSD">BTC/USD</option><option value="ETHUSD">ETH/USD</option>
                  <option value="LTCUSD">LTC/USD</option><option value="XRPUSD">XRP/USD</option>
                </optgroup>
              </select>
              
              <div id="accuracyIndicator" class="mt-2 flex items-center gap-2">
                <span id="accuracyBadge" class="accuracy-badge accuracy-high">‚úì Forex Universal</span>
                <span id="accuracyText" class="text-xs text-neutral-500"></span>
              </div>

              <div class="grid grid-cols-2 gap-4 mt-5">
                <div>
                  <label class="block text-sm font-semibold text-neutral-700">Divisa de la cuenta</label>
                  <select id="accountCcy" class="mt-1 w-full rounded-lg border-2 border-neutral-200 px-3 py-2.5 focus:border-brand focus:outline-none">
                    <option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option>
                    <option value="JPY">JPY</option><option value="CHF">CHF</option><option value="AUD">AUD</option>
                    <option value="CAD">CAD</option><option value="NZD">NZD</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-neutral-700">Balance de la cuenta</label>
                  <input id="balance" type="number" step="0.01" value="1000" class="mt-1 w-full rounded-lg border-2 border-neutral-200 px-3 py-2.5 focus:border-brand focus:outline-none" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                  <label class="block text-sm font-semibold text-neutral-700">Riesgo (%)</label>
                  <input id="riskPct" type="number" step="0.01" value="1" class="mt-1 w-full rounded-lg border-2 border-neutral-200 px-3 py-2.5 focus:border-brand focus:outline-none" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-neutral-700">Stop Loss (pips)</label>
                  <input id="stopPips" type="number" step="0.1" value="20" class="mt-1 w-full rounded-lg border-2 border-neutral-200 px-3 py-2.5 focus:border-brand focus:outline-none" />
                </div>
              </div>

              <!-- PRECIO DEL PAR - Din√°mico -->
              <div id="priceSection" class="mt-4 price-box rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="conversion-indicator text-lg">üí±</span>
                  <label id="priceLabel" class="block text-sm font-bold text-purple-800">Precio del Par</label>
                </div>
                <input id="pairPrice" type="number" step="0.00001" value="1.10000" class="w-full rounded-lg border-2 border-purple-300 bg-white px-3 py-2.5 focus:border-purple-500 focus:outline-none mono text-lg" />
                <p id="priceHelp" class="text-xs text-purple-700 mt-2"></p>
              </div>

              <!-- Precio de conversi√≥n adicional (para cruces) -->
              <div id="conversionSection" class="mt-4 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg hidden">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">üîÑ</span>
                  <label id="conversionLabel" class="block text-sm font-bold text-amber-800">Tipo de Cambio Adicional</label>
                </div>
                <input id="conversionRate" type="number" step="0.00001" value="1.00000" class="w-full rounded-lg border-2 border-amber-300 bg-white px-3 py-2.5 focus:border-amber-500 focus:outline-none mono" />
                <p id="conversionHelp" class="text-xs text-amber-700 mt-2"></p>
              </div>

              <div class="flex items-center gap-3 mt-6">
                <button id="btnCalc" class="flex-1 px-5 py-3 rounded-lg text-white font-semibold transition-all hover:opacity-90 active:scale-[0.98]" style="background:linear-gradient(135deg,#040D51,#0b1355)">üìä Calcular</button>
                <button id="btnReset" class="px-5 py-3 rounded-lg border-2 border-neutral-300 font-semibold text-neutral-600 hover:bg-neutral-50">‚Ü∫</button>
              </div>
            </div>
          </div>

          <!-- Especificaciones Broker (para no-forex) -->
          <div id="brokerSection" class="bg-white shadow-sm border rounded-xl overflow-hidden hidden">
            <div id="brokerToggle" class="collapsible-header p-4 flex items-center justify-between hover:bg-neutral-50">
              <div class="flex items-center gap-2">
                <span class="text-xl">üîß</span>
                <div>
                  <h3 class="font-bold text-brand">Especificaciones del Broker</h3>
                  <p class="text-xs text-neutral-500">Para Metales, √çndices, Cripto, Energ√≠as</p>
                </div>
              </div>
              <span id="brokerArrow" class="text-neutral-400 transition-transform">‚ñº</span>
            </div>
            <div id="brokerContent" class="collapsible-content">
              <div class="px-4 pb-4 border-t">
                <div class="info-box rounded-lg p-3 mt-4 text-sm">
                  <p class="text-blue-700">Para activos no-Forex, verifica el <b>Tama√±o de Contrato</b> y <b>Valor del Tick</b> en tu plataforma (click derecho ‚Üí Especificaci√≥n).</p>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-semibold text-neutral-700">Tama√±o Contrato</label>
                    <input id="brokerLotSize" type="number" step="0.01" value="100" class="mt-1 w-full rounded-lg border-2 border-amber-200 bg-amber-50/50 px-3 py-2.5 mono" />
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-neutral-700">Valor Tick/Lote</label>
                    <input id="brokerTickValue" type="number" step="0.01" value="1" class="mt-1 w-full rounded-lg border-2 border-amber-200 bg-amber-50/50 px-3 py-2.5 mono" />
                  </div>
                </div>
                <button id="btnApplyBroker" class="mt-4 w-full px-4 py-2 rounded-lg bg-amber-500 text-white font-semibold hover:bg-amber-600">‚úì Aplicar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- RESULTADOS -->
        <div class="space-y-6">
          <div class="bg-white shadow-sm border rounded-xl p-6">
            <div class="flex items-center gap-2 mb-5">
              <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-accent text-brand font-bold text-lg">üìä</span>
              <div>
                <h2 class="text-lg font-bold text-brand">Resultados</h2>
                <p class="text-xs text-neutral-500">Tu tama√±o de posici√≥n √≥ptimo</p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="result-card rounded-xl border-2 border-red-100 bg-red-50/50 p-4">
                <p class="text-sm text-red-600 font-medium">üí∞ Riesgo Monetario</p>
                <p id="riskMoneyOut" class="text-2xl font-bold mt-1 mono text-red-700">‚Äî</p>
              </div>
              <div class="result-card rounded-xl border-2 border-blue-100 bg-blue-50/50 p-4">
                <p class="text-sm text-blue-600 font-medium">üìè Valor por Pip/Lote</p>
                <p id="pipValueOut" class="text-lg font-bold mt-1 mono text-blue-700">‚Äî</p>
              </div>
              <div class="result-card rounded-xl border-2 border-brand/20 bg-brand/5 p-4">
                <p class="text-sm text-brand font-medium">üì¶ Unidades</p>
                <p id="unitsOut" class="text-2xl font-bold mt-1 mono text-brand">‚Äî</p>
              </div>
              <div class="result-card rounded-xl border-2 border-accent/40 bg-accent/10 p-4">
                <p class="text-sm text-amber-700 font-medium">üéØ Lotes</p>
                <p id="lotsOut" class="text-2xl font-bold mt-1 mono text-amber-700">‚Äî</p>
              </div>
              <div class="result-card rounded-xl border-2 border-green-100 bg-green-50/50 p-4">
                <p class="text-sm text-green-600 font-medium">Mini (0.1)</p>
                <p id="miniOut" class="text-xl font-bold mt-1 mono text-green-700">‚Äî</p>
              </div>
              <div class="result-card rounded-xl border-2 border-purple-100 bg-purple-50/50 p-4">
                <p class="text-sm text-purple-600 font-medium">Micro (0.01)</p>
                <p id="microOut" class="text-xl font-bold mt-1 mono text-purple-700">‚Äî</p>
              </div>
            </div>
          </div>

          <!-- F√≥rmula detallada -->
          <div class="bg-white shadow-sm border rounded-xl p-6">
            <h3 class="font-bold text-brand mb-3">üìê Desglose del C√°lculo</h3>
            <div id="formulaExplanation" class="text-sm space-y-2 bg-neutral-50 p-4 rounded-lg"></div>
          </div>

          <!-- Info conversi√≥n -->
          <div id="conversionInfo" class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-4">
            <h3 class="font-bold text-purple-800 mb-2">üí± Sobre la Conversi√≥n</h3>
            <p id="conversionExplanation" class="text-sm text-purple-700"></p>
          </div>
        </div>
      </div>

      <!-- Tabla de referencia de conversiones -->
      <div class="mt-8 bg-white rounded-xl shadow-sm border p-6">
        <h3 class="text-lg font-bold text-brand mb-4">üìã Gu√≠a de Conversi√≥n seg√∫n Divisa de Cuenta</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-brand/5">
                <th class="text-left p-3 font-semibold">Si tu cuenta es...</th>
                <th class="text-left p-3 font-semibold">Y operas...</th>
                <th class="text-left p-3 font-semibold">Necesitas...</th>
                <th class="text-left p-3 font-semibold">Ejemplo</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-100">
              <tr class="bg-green-50">
                <td class="p-3 font-medium">USD</td>
                <td class="p-3">XXX/USD (EUR/USD, GBP/USD...)</td>
                <td class="p-3"><span class="accuracy-badge accuracy-high">‚ùå Nada</span></td>
                <td class="p-3 text-neutral-600">Directo, $10/pip/lote</td>
              </tr>
              <tr>
                <td class="p-3 font-medium">USD</td>
                <td class="p-3">USD/XXX (USD/JPY, USD/CAD...)</td>
                <td class="p-3"><span class="category-badge cat-forex">Precio del par</span></td>
                <td class="p-3 text-neutral-600">USD/JPY @ 156.50 ‚Üí dividir</td>
              </tr>
              <tr>
                <td class="p-3 font-medium">USD</td>
                <td class="p-3">Cruces (EUR/JPY, GBP/CHF...)</td>
                <td class="p-3"><span class="category-badge cat-metals">Precio + TC a USD</span></td>
                <td class="p-3 text-neutral-600">EUR/JPY + USD/JPY</td>
              </tr>
              <tr class="bg-blue-50">
                <td class="p-3 font-medium">EUR</td>
                <td class="p-3">XXX/EUR (USD/EUR conceptual)</td>
                <td class="p-3"><span class="accuracy-badge accuracy-high">‚ùå Nada</span></td>
                <td class="p-3 text-neutral-600">Directo en EUR</td>
              </tr>
              <tr>
                <td class="p-3 font-medium">EUR</td>
                <td class="p-3">EUR/XXX, otros</td>
                <td class="p-3"><span class="category-badge cat-forex">Precio + TC a EUR</span></td>
                <td class="p-3 text-neutral-600">EUR/USD @ 1.10 ‚Üí dividir</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-neutral-500 mt-3">üí° La calculadora detecta autom√°ticamente qu√© precio(s) necesitas ingresar.</p>
      </div>

      <p class="text-center text-xs text-neutral-500 mt-8">¬© 2025 DF ACADEMY ¬∑ Herramienta educativa.</p>
    </section>
  </main>

  <script>
    // =============================================
    // BASE DE DATOS
    // =============================================
    const FX_PAIRS = {
      // Mayores
      EURUSD:{base:'EUR',quote:'USD',pip:0.0001,price:1.1000},
      GBPUSD:{base:'GBP',quote:'USD',pip:0.0001,price:1.2700},
      USDJPY:{base:'USD',quote:'JPY',pip:0.01,price:156.50},
      USDCHF:{base:'USD',quote:'CHF',pip:0.0001,price:0.8800},
      AUDUSD:{base:'AUD',quote:'USD',pip:0.0001,price:0.6600},
      USDCAD:{base:'USD',quote:'CAD',pip:0.0001,price:1.3600},
      NZDUSD:{base:'NZD',quote:'USD',pip:0.0001,price:0.6100},
      // Cruces EUR
      EURGBP:{base:'EUR',quote:'GBP',pip:0.0001,price:0.8650},
      EURJPY:{base:'EUR',quote:'JPY',pip:0.01,price:164.00},
      EURCHF:{base:'EUR',quote:'CHF',pip:0.0001,price:0.9700},
      EURAUD:{base:'EUR',quote:'AUD',pip:0.0001,price:1.6700},
      EURCAD:{base:'EUR',quote:'CAD',pip:0.0001,price:1.5000},
      EURNZD:{base:'EUR',quote:'NZD',pip:0.0001,price:1.8100},
      // Cruces GBP
      GBPJPY:{base:'GBP',quote:'JPY',pip:0.01,price:189.00},
      GBPCHF:{base:'GBP',quote:'CHF',pip:0.0001,price:1.1200},
      GBPAUD:{base:'GBP',quote:'AUD',pip:0.0001,price:1.9300},
      GBPCAD:{base:'GBP',quote:'CAD',pip:0.0001,price:1.7300},
      GBPNZD:{base:'GBP',quote:'NZD',pip:0.0001,price:2.1000},
      // Cruces otros
      AUDJPY:{base:'AUD',quote:'JPY',pip:0.01,price:98.00},
      AUDCHF:{base:'AUD',quote:'CHF',pip:0.0001,price:0.5800},
      AUDCAD:{base:'AUD',quote:'CAD',pip:0.0001,price:0.9000},
      AUDNZD:{base:'AUD',quote:'NZD',pip:0.0001,price:1.0900},
      CADJPY:{base:'CAD',quote:'JPY',pip:0.01,price:110.00},
      CADCHF:{base:'CAD',quote:'CHF',pip:0.0001,price:0.6500},
      CHFJPY:{base:'CHF',quote:'JPY',pip:0.01,price:169.00},
      NZDJPY:{base:'NZD',quote:'JPY',pip:0.01,price:90.00},
      NZDCHF:{base:'NZD',quote:'CHF',pip:0.0001,price:0.5400},
      NZDCAD:{base:'NZD',quote:'CAD',pip:0.0001,price:0.8300},
      // Ex√≥ticos USD
      USDMXN:{base:'USD',quote:'MXN',pip:0.0001,price:17.50},
      USDZAR:{base:'USD',quote:'ZAR',pip:0.0001,price:18.50},
      USDTRY:{base:'USD',quote:'TRY',pip:0.0001,price:32.00},
      USDSEK:{base:'USD',quote:'SEK',pip:0.0001,price:10.50},
      USDNOK:{base:'USD',quote:'NOK',pip:0.0001,price:10.80},
      USDDKK:{base:'USD',quote:'DKK',pip:0.0001,price:6.90},
      USDSGD:{base:'USD',quote:'SGD',pip:0.0001,price:1.35},
      USDHKD:{base:'USD',quote:'HKD',pip:0.0001,price:7.82},
      USDPLN:{base:'USD',quote:'PLN',pip:0.0001,price:4.00},
      USDHUF:{base:'USD',quote:'HUF',pip:0.01,price:360.00},
      USDCZK:{base:'USD',quote:'CZK',pip:0.0001,price:23.00},
      USDCNH:{base:'USD',quote:'CNH',pip:0.0001,price:7.25},
      // Ex√≥ticos EUR/GBP
      EURTRY:{base:'EUR',quote:'TRY',pip:0.0001,price:35.00},
      EURMXN:{base:'EUR',quote:'MXN',pip:0.0001,price:19.20},
      EURZAR:{base:'EUR',quote:'ZAR',pip:0.0001,price:20.30},
      EURSEK:{base:'EUR',quote:'SEK',pip:0.0001,price:11.50},
      EURNOK:{base:'EUR',quote:'NOK',pip:0.0001,price:11.80},
      EURPLN:{base:'EUR',quote:'PLN',pip:0.0001,price:4.40},
      GBPZAR:{base:'GBP',quote:'ZAR',pip:0.0001,price:23.50},
      GBPTRY:{base:'GBP',quote:'TRY',pip:0.0001,price:40.50},
      GBPMXN:{base:'GBP',quote:'MXN',pip:0.0001,price:22.20}
    };

    const NON_FX = {
      XAUUSD:{quote:'USD',lotSize:100,tickVal:1,note:'Oro: 1 lote = 100 oz'},
      XAGUSD:{quote:'USD',lotSize:5000,tickVal:50,note:'Plata: 1 lote = 5000 oz'},
      XAUEUR:{quote:'EUR',lotSize:100,tickVal:1,note:'Oro/EUR'},
      XPTUSD:{quote:'USD',lotSize:100,tickVal:1,note:'Platino'},
      USOIL:{quote:'USD',lotSize:100,tickVal:1,note:'WTI'},
      UKOIL:{quote:'USD',lotSize:100,tickVal:1,note:'Brent'},
      NGAS:{quote:'USD',lotSize:10000,tickVal:10,note:'Gas'},
      US30:{quote:'USD',lotSize:1,tickVal:1,note:'Dow Jones'},
      US500:{quote:'USD',lotSize:1,tickVal:0.1,note:'S&P 500'},
      US100:{quote:'USD',lotSize:1,tickVal:0.1,note:'NASDAQ'},
      GER40:{quote:'EUR',lotSize:1,tickVal:0.1,note:'DAX'},
      UK100:{quote:'GBP',lotSize:1,tickVal:0.1,note:'FTSE'},
      JPN225:{quote:'JPY',lotSize:1,tickVal:1,note:'Nikkei'},
      BTCUSD:{quote:'USD',lotSize:1,tickVal:1,note:'Bitcoin'},
      ETHUSD:{quote:'USD',lotSize:1,tickVal:0.1,note:'Ethereum'},
      LTCUSD:{quote:'USD',lotSize:1,tickVal:0.01,note:'Litecoin'},
      XRPUSD:{quote:'USD',lotSize:1000,tickVal:0.1,note:'Ripple'}
    };

    // Tipos de cambio de referencia para conversiones
    const CONVERSION_RATES = {
      USDJPY: 156.50, USDCHF: 0.88, USDCAD: 1.36, USDMXN: 17.50, USDZAR: 18.50,
      USDTRY: 32.00, USDSEK: 10.50, USDNOK: 10.80, USDDKK: 6.90, USDSGD: 1.35,
      USDHKD: 7.82, USDPLN: 4.00, USDHUF: 360, USDCZK: 23.00, USDCNH: 7.25,
      EURUSD: 1.10, GBPUSD: 1.27, AUDUSD: 0.66, NZDUSD: 0.61,
      EURGBP: 0.865, EURJPY: 164, EURCHF: 0.97, GBPJPY: 189, GBPCHF: 1.12
    };

    let customBroker = { enabled: false, lotSize: 100, tickValue: 1 };

    // =============================================
    // FUNCIONES DE AN√ÅLISIS
    // =============================================
    function getSymbolInfo(symbol) {
      if (FX_PAIRS[symbol]) return { type: 'forex', ...FX_PAIRS[symbol] };
      if (NON_FX[symbol]) return { type: 'other', ...NON_FX[symbol] };
      return null;
    }

    function analyzeConversion(symbol, accountCcy) {
      const info = getSymbolInfo(symbol);
      if (!info) return { needsPrice: false };

      const quote = info.quote;
      
      // Si la cuenta es igual a la cotizada, no necesita conversi√≥n
      if (accountCcy === quote) {
        return {
          needsPrice: false,
          direct: true,
          message: `Tu cuenta (${accountCcy}) = Cotizada (${quote}). Conversi√≥n directa.`
        };
      }

      // Si es Forex
      if (info.type === 'forex') {
        // Caso 1: Cuenta USD, cotizada diferente
        if (accountCcy === 'USD') {
          if (quote === 'JPY' || quote === 'CHF' || quote === 'CAD' || quote === 'MXN' || 
              quote === 'ZAR' || quote === 'TRY' || quote === 'SEK' || quote === 'NOK' ||
              quote === 'DKK' || quote === 'SGD' || quote === 'HKD' || quote === 'PLN' ||
              quote === 'HUF' || quote === 'CZK' || quote === 'CNH') {
            // Necesita el precio del par para convertir
            return {
              needsPrice: true,
              priceType: 'pair',
              operation: 'divide',
              message: `Dividir por precio del par para convertir ${quote} ‚Üí USD`,
              defaultPrice: info.price
            };
          }
          if (quote === 'GBP' || quote === 'EUR' || quote === 'AUD' || quote === 'NZD') {
            // Necesita multiplicar por el TC de esa divisa a USD
            const convPair = quote + 'USD';
            return {
              needsPrice: true,
              priceType: 'conversion',
              operation: 'multiply',
              conversionPair: convPair,
              message: `Multiplicar por ${convPair} para convertir ${quote} ‚Üí USD`,
              defaultPrice: info.price,
              defaultConversion: CONVERSION_RATES[convPair] || 1
            };
          }
        }

        // Caso 2: Cuenta EUR
        if (accountCcy === 'EUR') {
          if (quote === 'USD') {
            return {
              needsPrice: true,
              priceType: 'pair',
              operation: 'divide',
              conversionPair: 'EURUSD',
              message: `Dividir por EUR/USD para convertir USD ‚Üí EUR`,
              defaultPrice: info.price,
              defaultConversion: CONVERSION_RATES['EURUSD'] || 1.10
            };
          }
          // Otras cotizadas con cuenta EUR
          return {
            needsPrice: true,
            priceType: 'complex',
            message: `Necesitas convertir ${quote} ‚Üí EUR`,
            defaultPrice: info.price
          };
        }

        // Caso gen√©rico: cuenta diferente de cotizada
        return {
          needsPrice: true,
          priceType: 'pair',
          operation: 'divide',
          message: `Convertir ${quote} ‚Üí ${accountCcy} usando precio del par`,
          defaultPrice: info.price
        };
      }

      // No-Forex (metales, √≠ndices, etc.)
      return {
        needsPrice: quote !== accountCcy,
        priceType: 'broker',
        message: info.note + ' - Verificar especificaciones del broker'
      };
    }

    // =============================================
    // UI UPDATES
    // =============================================
    function updateUI() {
      const symbol = document.getElementById('symbol').value;
      const accountCcy = document.getElementById('accountCcy').value;
      const info = getSymbolInfo(symbol);
      const conv = analyzeConversion(symbol, accountCcy);

      // Mostrar/ocultar secci√≥n de broker
      const brokerSection = document.getElementById('brokerSection');
      brokerSection.classList.toggle('hidden', info?.type === 'forex');

      // Actualizar secci√≥n de precio
      const priceSection = document.getElementById('priceSection');
      const priceLabel = document.getElementById('priceLabel');
      const priceHelp = document.getElementById('priceHelp');
      const priceInput = document.getElementById('pairPrice');

      if (conv.needsPrice || info?.type === 'forex') {
        priceSection.classList.remove('hidden');
        priceLabel.textContent = `Precio de ${symbol}`;
        priceHelp.textContent = conv.message || 'Ingresa el precio actual del par';
        priceInput.value = conv.defaultPrice || info?.price || 1;
      } else {
        priceSection.classList.add('hidden');
      }

      // Secci√≥n de conversi√≥n adicional
      const convSection = document.getElementById('conversionSection');
      const convLabel = document.getElementById('conversionLabel');
      const convHelp = document.getElementById('conversionHelp');
      const convInput = document.getElementById('conversionRate');

      if (conv.operation === 'multiply' && conv.conversionPair) {
        convSection.classList.remove('hidden');
        convLabel.textContent = `Precio de ${conv.conversionPair}`;
        convHelp.textContent = `Necesario para convertir a ${accountCcy}`;
        convInput.value = conv.defaultConversion || 1;
      } else {
        convSection.classList.add('hidden');
      }

      // Badge de precisi√≥n
      const badge = document.getElementById('accuracyBadge');
      const badgeText = document.getElementById('accuracyText');
      if (info?.type === 'forex') {
        badge.className = 'accuracy-badge accuracy-high';
        badge.textContent = '‚úì Forex Universal';
        badgeText.textContent = '1 lote = 100,000 unidades';
      } else {
        badge.className = 'accuracy-badge accuracy-low';
        badge.textContent = '‚ö†Ô∏è Verificar Broker';
        badgeText.textContent = 'Ajusta especificaciones abajo';
      }

      // Actualizar info de conversi√≥n
      document.getElementById('conversionExplanation').textContent = conv.message || 'Sin conversi√≥n necesaria';

      recalc();
    }

    // =============================================
    // C√ÅLCULO PRINCIPAL
    // =============================================
    function recalc() {
      const symbol = document.getElementById('symbol').value;
      const accountCcy = document.getElementById('accountCcy').value;
      const balance = Number(document.getElementById('balance').value) || 0;
      const riskPct = Number(document.getElementById('riskPct').value) || 0;
      const stopPips = Number(document.getElementById('stopPips').value) || 1;
      const pairPrice = Number(document.getElementById('pairPrice').value) || 1;
      const conversionRate = Number(document.getElementById('conversionRate').value) || 1;

      const info = getSymbolInfo(symbol);
      const conv = analyzeConversion(symbol, accountCcy);
      const riskMoney = balance * (riskPct / 100);

      let pipValuePerLot, lots, units, lotSize;
      let steps = [];

      if (info?.type === 'forex') {
        // ========== FOREX ==========
        lotSize = 100000;
        const pipSize = info.pip;
        const quote = info.quote;

        // Valor del pip en la divisa cotizada (por 1 lote)
        const pipInQuote = pipSize * lotSize;
        steps.push(`1. Pip en ${quote}: ${pipSize} √ó ${lotSize.toLocaleString()} = <b>${pipInQuote.toLocaleString()} ${quote}</b>`);

        // Convertir a la divisa de la cuenta
        if (accountCcy === quote) {
          // Directo
          pipValuePerLot = pipInQuote;
          steps.push(`2. Tu cuenta es ${accountCcy} = Cotizada. <b>Sin conversi√≥n</b>`);
        } else if (conv.operation === 'divide') {
          // Dividir por precio
          pipValuePerLot = pipInQuote / pairPrice;
          steps.push(`2. Convertir: ${pipInQuote.toLocaleString()} ${quote} √∑ ${pairPrice} = <b>${pipValuePerLot.toFixed(2)} ${accountCcy}</b>`);
        } else if (conv.operation === 'multiply') {
          // Multiplicar por TC
          pipValuePerLot = pipInQuote * conversionRate;
          steps.push(`2. Convertir: ${pipInQuote.toLocaleString()} ${quote} √ó ${conversionRate} = <b>${pipValuePerLot.toFixed(2)} ${accountCcy}</b>`);
        } else {
          // Fallback
          pipValuePerLot = pipInQuote / pairPrice;
          steps.push(`2. Convertir: ${pipInQuote.toLocaleString()} √∑ ${pairPrice} = <b>${pipValuePerLot.toFixed(2)} ${accountCcy}</b>`);
        }

        // Calcular lotes
        lots = riskMoney / (stopPips * pipValuePerLot);
        units = lots * lotSize;

        steps.push(`3. Riesgo: ${balance} √ó ${riskPct}% = <b>${riskMoney.toFixed(2)} ${accountCcy}</b>`);
        steps.push(`4. Lotes: ${riskMoney.toFixed(2)} √∑ (${stopPips} √ó ${pipValuePerLot.toFixed(2)}) = <b class="text-green-600">${lots.toFixed(2)} lotes</b>`);
        steps.push(`5. Unidades: ${lots.toFixed(2)} √ó ${lotSize.toLocaleString()} = <b class="text-green-600">${Math.round(units).toLocaleString()}</b>`);

      } else if (info) {
        // ========== NO-FOREX ==========
        lotSize = customBroker.enabled ? customBroker.lotSize : info.lotSize;
        pipValuePerLot = customBroker.enabled ? customBroker.tickValue : info.tickVal;

        lots = riskMoney / (stopPips * pipValuePerLot);
        units = lots * lotSize;

        steps.push(`1. Valor tick/lote: <b>${pipValuePerLot} ${accountCcy}</b> ${customBroker.enabled ? '(personalizado)' : '(por defecto)'}`);
        steps.push(`2. Riesgo: ${balance} √ó ${riskPct}% = <b>${riskMoney.toFixed(2)} ${accountCcy}</b>`);
        steps.push(`3. Lotes: ${riskMoney.toFixed(2)} √∑ (${stopPips} √ó ${pipValuePerLot}) = <b class="text-green-600">${lots.toFixed(2)} lotes</b>`);
        if (!customBroker.enabled) {
          steps.push(`<span class="text-amber-600">‚ö†Ô∏è Usando valores por defecto. Verifica con tu broker.</span>`);
        }
      } else {
        lots = 0; units = 0; pipValuePerLot = 0; lotSize = 100000;
      }

      // Actualizar UI
      document.getElementById('riskMoneyOut').textContent = riskMoney.toFixed(2) + ' ' + accountCcy;
      document.getElementById('pipValueOut').textContent = pipValuePerLot.toFixed(2) + ' ' + accountCcy + '/pip';
      document.getElementById('unitsOut').textContent = Math.round(units).toLocaleString();
      document.getElementById('lotsOut').textContent = lots.toFixed(2);
      document.getElementById('miniOut').textContent = (lots * 10).toFixed(2);
      document.getElementById('microOut').textContent = (lots * 100).toFixed(1);

      document.getElementById('formulaExplanation').innerHTML = steps.map(s => `<div class="py-1 border-b border-neutral-200 last:border-0">${s}</div>`).join('');
    }

    function fmt(n, d=2) { return isFinite(n) ? n.toFixed(d) : '‚Äî'; }

    function resetForm() {
      document.getElementById('symbol').value = 'EURUSD';
      document.getElementById('accountCcy').value = 'USD';
      document.getElementById('balance').value = 1000;
      document.getElementById('riskPct').value = 1;
      document.getElementById('stopPips').value = 20;
      customBroker.enabled = false;
      updateUI();
    }

    function applyBrokerSpecs() {
      customBroker.enabled = true;
      customBroker.lotSize = Number(document.getElementById('brokerLotSize').value) || 100;
      customBroker.tickValue = Number(document.getElementById('brokerTickValue').value) || 1;
      recalc();
      const btn = document.getElementById('btnApplyBroker');
      btn.textContent = '‚úì Aplicado!';
      btn.classList.replace('bg-amber-500','bg-green-500');
      setTimeout(() => { btn.textContent = '‚úì Aplicar'; btn.classList.replace('bg-green-500','bg-amber-500'); }, 1500);
    }

    // =============================================
    // EVENTOS
    // =============================================
    document.getElementById('symbol').addEventListener('change', updateUI);
    document.getElementById('accountCcy').addEventListener('change', updateUI);
    ['balance','riskPct','stopPips','pairPrice','conversionRate'].forEach(id => {
      document.getElementById(id).addEventListener('input', recalc);
    });
    document.getElementById('btnCalc').addEventListener('click', recalc);
    document.getElementById('btnReset').addEventListener('click', resetForm);
    document.getElementById('btnApplyBroker').addEventListener('click', applyBrokerSpecs);

    // Collapsible
    document.getElementById('brokerToggle')?.addEventListener('click', () => {
      document.getElementById('brokerContent').classList.toggle('open');
      document.getElementById('brokerArrow').style.transform = 
        document.getElementById('brokerContent').classList.contains('open') ? 'rotate(180deg)' : '';
    });

    // INIT
    updateUI();
  </script>
</body>
</html>
